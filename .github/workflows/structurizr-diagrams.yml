name: Structurizr Export Workflow

on: [push, pull_request]

jobs:
  export-diagrams:
    runs-on: ubuntu-latest

    services:
      structurizr:
        image: structurizr/lite:latest
        ports:
          - 8080:8080
        volumes:
          - ${{ github.workspace }}/docs:/usr/local/structurizr:rw
        options: --network-alias structurizr

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          clean: true
          fetch-depth: 1

      - name: Verificar conteúdo da pasta docs
        run: ls -la ${{ github.workspace }}/docs

      - name: Verificar diretório no container
        run: docker exec $(docker ps --filter "name=structurizr" --format "{{.ID}}") ls -la /usr/local/structurizr

      - name: Testar disponibilidade do Structurizr
        run: curl -I http://localhost:8080

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Instalar dependências
        run: |
          cd .github/actions/structurizr-export
          npm install

      - name: Exportar Diagramas
        run: |
          cd .github/actions/structurizr-export
          node export-diagrams.js http://structurizr:8080/workspace/diagrams png

      - name: Listar Diagramas Gerados
        run: ls -la ./docs/diagrams

      - name: Verificar Logs
        run: |
          echo "Diretório atual:"
          pwd
          echo "Arquivos encontrados:"
          find . -name "*.png"

      - name: Upload Diagramas
        uses: actions/upload-artifact@v4
        with:
          name: structurizr-diagrams
          path: ./docs/diagrams/